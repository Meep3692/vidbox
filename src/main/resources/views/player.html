<!DOCTYPE html>
<html lang="en", xmlns:th="https://www.thymeleaf.org">
    <head>
        <title>
            Player
        </title>
        <link rel="stylesheet" href="/static/style.css">
        
    </head>
    <body>
        <h1>Player</h1>
        <form action="/player/enqueue" method="post" enctype="application/json">
            <label for="source">Source</label>
            <input type="text" name="source">
            <input type="submit" value="Add to queue">
        </form>
        <input id="seekbar" onchange="seek()" type="range" min="0" max="100" value="0"><br>
        <button onclick="prev()">Prev</button>
        <button id="pauseButton" onclick="pause()">Pause</button>
        <button onclick="next()">Next</button>
        <h2>Playlist</h2>
        <ol id="vidlist">
            <li class="playlist" th:each="item,status : ${playlist}">
                <div class="video" >
                    <div class="video-thumbnail-container">
                        <img class="video-thumbnail" th:src="@{/thumbnail.png(source=${item.source})}"/>
                    </div>
                    <div class="video-details">
                        <a th:href="@{'/player/skipto/'+${status.index}}">
                            <h2 class="video-title" th:text="${item.name}"></h2>
                        </a>
                        <p class="video-source" th:text="${item.source}"></p>
                    </div>
                </div>
            </li>
        </ol>
        <template id="video-template">
            <li class="playlist">
                <div class="video">
                    <div class="video-thumbnail-container">
                        <img class="video-thumbnail" src="/thumbnail.png?source=$source"/>
                    </div>
                    <div class="video-details">
                        <a href="/player/skipto/$index">
                            <h2 class="video-title">$name</h2>
                        </a>
                        <p class="video-source">
                            $source
                        </p>
                    </div>
                </div>
            </li>
        </template>
        <script>
            let vidlist = document.getElementById("vidlist");
            let webSocket = new WebSocket("ws://" + location.hostname + ":" + location.port + "/clicker");
            let paused = false;
            const seekbar = document.getElementById("seekbar");
            const template = document.getElementById("video-template");
            webSocket.onmessage = (msg) => {
                let data = JSON.parse(msg.data);
                //console.log(data);
                if(data.playlist){
                    vidlist.innerHTML = "";
                    for(let i = 0; i < data.playlist.length; i++){
                        let video = data.playlist[i];
                        let clone = template.content.firstElementChild.cloneNode(true);
                        clone.innerHTML = clone.innerHTML.replaceAll("$source", video.source).replaceAll("$name", video.name).replaceAll("$index", i);
                        if(i == data.playing){
                            clone.classList.add("playing");
                        }
                        vidlist.append(clone);
                    }
                }
                document.getElementById("pauseButton").innerText = data.paused ? "Play" : "Pause";
                paused = data.paused;
                seekbar.max = data.playingLength;
                seekbar.value = data.playingPosition;
            };

            function prev(){
                webSocket.send("prev");
            }

            function next(){
                webSocket.send("next");
            }

            function pause(){
                if(paused){
                    webSocket.send("play");
                }else{
                    webSocket.send("pause");
                }
            }

            function seek(){
                webSocket.send("seek" + seekbar.value);
            }
            
        </script>
    </body>
</html>